# Фидбэк

Раздел **«Фидбэк»** — это административная витрина отзывов студентов по занятиям: фильтрация, сортировка, управление видимостью, создание и редактирование записей. На больших объёмах данных (тысячи отзывов) страница остаётся «рабочей» за счёт серверной пагинации и запросов с параметрами.

Скриншоты для README:

* Общий вид и метрики: `imgs/Feedback/Feedback1.png`
* Модалка создания: `imgs/Feedback/Feedback2.png`, `imgs/Feedback/Feedback3.png`
* Модалка редактирования: `imgs/Feedback/Feedback4.png`
* Примеры фильтрации/выдачи: `imgs/Feedback/Feedback5.png`, `imgs/Feedback/Feedback6.png`

---

### 1) Назначение и сценарии использования

**Цель:** дать администратору единое место, где можно:

1. видеть все отзывы по занятиям (таблица + быстрые метрики);
2. находить отзывы по студенту/курсу/уроку/тексту;
3. быстро управлять видимостью (показать/скрыть);
4. добавлять отзывы вручную (демо/проверки/модерация);
5. редактировать оценки и комментарии без доступа к БД.

Типичный сценарий:

* Администратор открывает «Фидбэк», фильтрует по курсу и оценке, проверяет комментарии, скрывает токсичные/нерелевантные, при необходимости правит оценку/текст и сохраняет.

---

### 2) Роли и доступ

В UI явно отмечено, что это админский раздел (см. `imgs/Feedback/Feedback1.png`: подпись «Администратор»).

**Рекомендуемая модель доступа (логически):**

* Только **ADMIN** может:

  * просматривать все отзывы;
  * создавать отзывы;
  * редактировать отзывы;
  * скрывать/показывать отзывы.
* Остальные роли (TEACHER/STUDENT) либо не видят раздел, либо получают ограниченный режим (если он предусмотрен отдельной логикой проекта).

На API-уровне это обычно обеспечивается проверкой JWT-токена и роли пользователя на защищённых эндпоинтах. FastAPI-типовой подход — OAuth2 + Bearer JWT.

---

### 3) Структура страницы (UI)

#### 3.1 Шапка и действия

На странице есть:

* заголовок «Фидбэк»;
* кнопка **Обновить**;
* кнопка **Создать** (см. `imgs/Feedback/Feedback1.png`).

Кнопки работают так:

* **Обновить**: повторный запрос списка (и метрик) с текущими фильтрами.
* **Создать**: открывает модальное окно создания отзыва.

#### 3.2 Панель фильтров

Верхняя панель включает:

* поисковую строку (по студенту/курсу/уроку/комментарию);
* селект курса;
* селект оценки (например, «Любая оценка», «Только 5»);
* селект сортировки (например, «Сначала новые»);
* переключатель «Показывать скрытые» (см. `imgs/Feedback/Feedback1.png`, `imgs/Feedback/Feedback6.png`).

Практически это реализуется через контролируемые состояния + единый запрос на бэкенд с query-параметрами. Для таблиц Ant Design типовой паттерн — обрабатывать `onChange` таблицы и синхронизировать пагинацию/сортировку/фильтры с сервером. ([Ant Design][1])

---

### 4) Быстрые метрики (карточки)

Под фильтрами отображаются KPI-карточки (см. `imgs/Feedback/Feedback1.png`):

1. **Показано отзывов** — сколько записей в текущей выборке (после фильтров).
2. **Средняя оценка** — агрегат по выборке.
3. **Скрытых** и доля скрытых — модерационная метрика.
4. **За 7 дней** — «свежие отзывы» за неделю.

**Важно:** на больших объёмах (8000+) эти метрики должны считаться сервером агрегатными запросами (COUNT/AVG), а не вычисляться на фронтенде по текущей странице таблицы, иначе метрика будет неверной и «дорогой» по времени.

---

### 5) Таблица отзывов

См. общий вид: `imgs/Feedback/Feedback1.png`, и пример пагинации на больших данных: `imgs/Feedback/Feedback5.png`.

#### 5.1 Колонки (по факту UI)

* **Студент**
* **Оценка** (звёзды)
* **Комментарий** (в таблице укороченный, полный текст по ховеру/tooltip)
* **Курс**
* **Урок**
* **Дата**
* **Видимость** (например, «Видимый»)
* **Действия** → «Редактировать»

Для Ant Design таблицы нормальная реализация “tooltip по ховеру” — рендер ячейки с обрезкой + Tooltip/Popover.

#### 5.2 Пагинация и производительность

Судя по скриншотам (страницы ~795–801), пагинация рассчитана на тысячи записей и обязана быть серверной:

* фронт хранит `page` и `pageSize`;
* при смене страницы запрашивает новые данные;
* сервер возвращает `items` + `total`.

Ant Design Table поддерживает серверный режим через `pagination` и `onChange`. ([Ant Design][1])

---

### 6) Создание отзыва (модалка)

См. `imgs/Feedback/Feedback2.png` и `imgs/Feedback/Feedback3.png`.

Поля:

* **Student ID** (обязательное)
* **Курс** (обязательное)
* **Урок** (обязательное)
* **Оценка** (звёзды)
* **Комментарий** (textarea)
* **Скрытый** (переключатель)
* Кнопки: **Отмена / Создать**

#### 6.1 Зависимости полей

Нормальная логика выбора:

1. выбирается курс;
2. список уроков фильтруется по курсу;
3. выбирается урок.

Это снижает риск создать отзыв «на урок не из того курса».

#### 6.2 Валидация

Типовой набор правил:

* Student ID: required, integer > 0
* Course: required
* Lesson: required
* Rating: required, диапазон 0..5 (или 1..5), допускаются дробные значения (в сид-данных встречаются 4.8 и т.п.)
* Comment: ограничение длины (например, 1..500/1000), запрет пустых строк если required

В Ant Design это обычно делается через `Form` и `rules` у `Form.Item`. ([Ant Design][2])

#### 6.3 Оценка звёздами

Используется `Rate`:

* поддерживает дробные значения через `allowHalf` (если это включено);
* допускает очистку значения через `allowClear` (по необходимости). ([Ant Design][3])

---

### 7) Редактирование отзыва (модалка)

См. `imgs/Feedback/Feedback4.png`.

Обычно редактируются:

* оценка,
* комментарий,
* флаг скрытости (видимость).

Кнопки: **Отмена / Сохранить**.

Практический нюанс: чтобы при закрытии модалки не сохранялись старые значения формы и не было «миганий» состояния, часто используют `destroyOnClose`/`destroyOnHidden` или сброс формы при закрытии. В Ant Design для таких кейсов есть стандартные параметры модалки, а для форм внутри модалки — управление сохранением состояния. ([FastAPI][4])

---

### 8) Контракт API (логика взаимодействия фронт ↔ бэк)

Ниже — то, как это должно быть организовано логически (даже если названия параметров отличаются, смысл сохраняется).

#### 8.1 Получение списка

`GET /api/v1/feedback`

Query-параметры (типовой набор для вашего UI):

* `page`, `page_size`
* `q` (поиск)
* `course_id`
* `rating` или `rating_min/rating_max`
* `show_hidden` или `is_hidden`
* `sort` (например, `created_at_desc`)

Ответ:

```json
{
  "items": [
    {
      "id": 123,
      "student_id": 101,
      "student_name": "…",
      "course_id": 7,
      "course_name": "…",
      "lesson_id": 34,
      "lesson_title": "…",
      "date": "2025-10-23",
      "rating": 4.5,
      "comment": "…",
      "is_hidden": false,
      "created_at": "…"
    }
  ],
  "total": 8001
}
```

#### 8.2 Метрики

Вариант А (рекомендованный): отдельный эндпоинт агрегатов, чтобы не мешать таблицу и статистику:
`GET /api/v1/feedback/metrics` с теми же фильтрами.

Ответ:

```json
{
  "shown_total": 8001,
  "avg_rating": 4.43,
  "hidden_total": 0,
  "last_7_days": 8001
}
```

Вариант Б: возвращать метрики в ответе списка (как `meta`), но следить за кэшированием/нагрузкой.

#### 8.3 Создание

`POST /api/v1/feedback`

```json
{
  "student_id": 101,
  "course_id": 3,
  "lesson_id": 34,
  "rating": 1.0,
  "comment": "…",
  "is_hidden": false
}
```

#### 8.4 Обновление

`PATCH /api/v1/feedback/{id}`

```json
{
  "rating": 2.0,
  "comment": "…",
  "is_hidden": true
}
```

#### 8.5 Авторизация запросов

Все запросы раздела должны уходить с заголовком:
`Authorization: Bearer <JWT>`

Это стандартный режим работы FastAPI security flow.

---

### 9) Модель данных (что хранится)

Минимально необходимые поля для таблицы отзывов:

* `id`
* `student_id` (FK на users)
* `lesson_id` (FK на lessons)
* `rating` (float)
* `comment` (text)
* `is_hidden` (bool)
* `created_at` (datetime)

Производительные индексы (важно при 8000+ и росте):

* `(lesson_id)`, `(student_id)`, `(created_at)`, `(is_hidden)`, возможно `(rating)`
* если поиск по комментарию: либо ограничиться `ILIKE` (дороже), либо использовать полнотекстовый индекс (PostgreSQL) при необходимости.

Бизнес-правило, которое часто добавляют:

* уникальность `(student_id, lesson_id)` — один отзыв на занятие от одного студента (если это логика продукта). Иначе будут дубли, метрики «поплывут».

---

### 10) Проверка работоспособности (чеклист)

1. Открыть `imgs/Feedback/Feedback1.png`-экран:

   * таблица загрузилась,
   * метрики корректны,
   * кнопки «Обновить/Создать» активны.
2. Поиск:

   * ввод части имени студента → количество записей меняется.
3. Фильтр по курсу:

   * выбор курса → таблица и метрики меняются.
4. Фильтр по оценке:

   * «Только 5» → остаются только максимальные оценки.
5. Сортировка:

   * «Сначала новые» меняет порядок.
6. Пагинация:

   * переход на другую страницу не ломает фильтры.
7. Создание:

   * открыть модалку (`imgs/Feedback/Feedback2.png`),
   * заполнить обязательные поля,
   * сохранить → новая запись появляется в таблице.
8. Редактирование:

   * открыть (`imgs/Feedback/Feedback4.png`),
   * изменить оценку/комментарий/hidden,
   * сохранить → строка обновилась, видимость изменилась.
9. Скрытые:

   * включить «Показывать скрытые» → скрытые появляются/прячутся согласно тумблеру.

---

Если дальше по README ты хочешь выдержать одинаковый стандарт, то для следующего раздела («Экспорт» или «Профиль») можно сохранять ту же структуру: назначение → UI → сценарии → API → модель данных → чеклист.

[1]: https://ant.design/components/table/ " Table - Ant Design"
[2]: https://ant.design/components/form/ " Form - Ant Design"
[3]: https://ant.design/components/rate/ " Rate - Ant Design"
[4]: https://fastapi.tiangolo.com/tutorial/security/oauth2-jwt/ "OAuth2 with Password (and hashing), Bearer with JWT tokens - FastAPI"
